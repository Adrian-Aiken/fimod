// ==UserScript==
// @name        fimod
// @author      sidke
// @namespace   https://github.com/sidke/fimod
// @description factory idle mod
// @include     http://factoryidle.com/*
// @version     1.06.7
// @grant       none
// @run-at      document-start
// ==/UserScript==
(function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})({1:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();var _storage=require("./lib/storage");var _storage2=_interopRequireDefault(_storage);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{"default":obj}}function _toConsumableArray(arr){if(Array.isArray(arr)){for(var i=0,arr2=Array(arr.length);i<arr.length;i++){arr2[i]=arr[i]}return arr2}else{return Array.from(arr)}}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}var Fimod=function(){_createClass(Fimod,null,[{key:"require",value:function require(paths){return new Promise(function(resolve){window.require(paths,function(){for(var _len=arguments.length,modules=Array(_len),_key=0;_key<_len;_key++){modules[_key]=arguments[_key]}return resolve(modules)})})}},{key:"define",value:function define(){var fimod=new(Function.prototype.bind.apply(Fimod,[null].concat(Array.prototype.slice.call(arguments))));Fimod.mods.push(fimod)}},{key:"load",value:function load(){var promise=Promise.resolve();Fimod.mods.sort(function(a,b){return a.weight-b.weight}).map(function(fimod){promise=promise.then(function(){return Fimod.require(fimod.paths).then(function(modules){return fimod.load(modules)})})});return promise}},{key:"wrap",value:function wrap(cls,method,fn){var supr=cls.prototype[method];cls.prototype[method]=function(){for(var _len2=arguments.length,args=Array(_len2),_key2=0;_key2<_len2;_key2++){args[_key2]=arguments[_key2]}fn.call.apply(fn,[this,supr.bind(this)].concat(args))}}},{key:"mods",get:function get(){if(this._mods===undefined)this._mods=[];return this._mods}},{key:"storage",get:function get(){if(this._storage===undefined)this._storage=new _storage2.default("Fimod");return this._storage}},{key:"version",get:function get(){return GM_info.script.version}}]);function Fimod(properties,paths,install){_classCallCheck(this,Fimod);if(install===undefined)install=paths;Object.assign(this,{name:"no name",description:"no description",enabled:true,system:false,weight:0,paths:paths,install:install},properties);this.enabled=Fimod.storage.get("module."+this.name,this.enabled)}_createClass(Fimod,[{key:"toggle",value:function toggle(){var value=arguments.length<=0||arguments[0]===undefined?null:arguments[0];this.enabled=value!==null?value:!this.enabled;Fimod.storage.set("module."+this.name,this.enabled)}},{key:"load",value:function load(modules){if(this.enabled===false&&this.system===false)return;console.log("Installing Fimod: "+this.name);return this.install.apply(this,_toConsumableArray(modules))}}]);return Fimod}();exports.default=Fimod},{"./lib/storage":4}],2:[function(require,module,exports){"use strict";if(navigator.userAgent.toLowerCase().indexOf("chrome")>-1){var observer=new MutationObserver(function(mutations){mutations.map(function(mutation){if(mutation.addedNodes.length===0)return;var node=mutation.addedNodes[0];if(node.tagName=="SCRIPT"){var event=new Event("beforescriptexecute",{bubbles:true,cancelable:true});var canceled=!node.dispatchEvent(event);if(canceled)node.src=""}})});observer.observe(document.documentElement,{childList:true,subtree:true})}},{}],3:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.clamp=clamp;function clamp(v,a,b){return Math.min(Math.max(v,a),b)}},{}],4:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}var Storage=function(){function Storage(key){_classCallCheck(this,Storage);this.key=key;this.load()}_createClass(Storage,[{key:"load",value:function load(){var json=localStorage.getItem(this.key);this.data=JSON.parse(json||"{}")}},{key:"save",value:function save(){localStorage.setItem(this.key,JSON.stringify(this.data))}},{key:"get",value:function get(key,d){var value=this.data[key];if(value===undefined)return d;return value}},{key:"set",value:function set(key,value){this.data[key]=value;this.save()}}]);return Storage}();exports.default=Storage},{}],5:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.preventScript=preventScript;exports.getScript=getScript;exports.insertElement=insertElement;exports.insertScript=insertScript;exports.insertStyle=insertStyle;function preventScript(src){document.addEventListener("beforescriptexecute",function(event){if(event.target.src==src){event.preventDefault()}},true)}function getScript(src){return fetch(src).then(function(response){return response.text()})}function insertElement(data,tag){var element=document.createElement(tag);element.textContent=data.toString();document.head.appendChild(element)}function insertScript(data){insertElement(data,"script")}function insertStyle(data){insertElement(data,"style")}},{}],6:[function(require,module,exports){"use strict";var _slicedToArray=function(){function sliceIterator(arr,i){var _arr=[];var _n=true;var _d=false;var _e=undefined;try{for(var _i=arr[Symbol.iterator](),_s;!(_n=(_s=_i.next()).done);_n=true){_arr.push(_s.value);if(i&&_arr.length===i)break}}catch(err){_d=true;_e=err}finally{try{if(!_n&&_i["return"])_i["return"]()}finally{if(_d)throw _e}}return _arr}return function(arr,i){if(Array.isArray(arr)){return arr}else if(Symbol.iterator in Object(arr)){return sliceIterator(arr,i)}else{throw new TypeError("Invalid attempt to destructure non-iterable instance")}}}();var _fimod=require("./fimod");var _fimod2=_interopRequireDefault(_fimod);var _utility=require("./lib/utility");require("./lib/beforescriptexecute-polyfill.js");require("./mods");function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{"default":obj}}var SCRIPT_SRC="http://factoryidle.com/app.js";var loadingMessage=void 0;(0,_utility.preventScript)(SCRIPT_SRC);(0,_utility.getScript)(SCRIPT_SRC).then(function(source){if(window.top!==window.self)document.body.classList.add("iframe");loadingMessage=document.querySelector("#loadingMessage");loadingMessage.innerText="Loading Fimod...";var variables=["require","define","BinaryTest","isBrowserSupported","PlayFab","logger","GameUiEvent","GameEvent","FactoryEvent","GlobalUiEvent","ApiEvent"];var object="{"+variables.map(function(v){return'"'+v+'": '+v}).join(", ")+"}";var start=source.indexOf("var MainInstance");return new Promise(function(resolve){window.__FIMOD_RESOLVE__=resolve;(0,_utility.insertScript)(source.substring(0,start)+"; __FIMOD_RESOLVE__("+object+"); }()")})}).then(function(variables){Object.keys(variables).map(function(key){window[key]=variables[key]});return _fimod2.default.require(["text!template/settings.html"]).then(function(_ref){var _ref2=_slicedToArray(_ref,1);var template=_ref2[0];var version=void 0;try{version=template.match(/Version ([\d\.]+)/)[1]}finally{if(version==_fimod2.default.version.substring(0,version.length))return;loadingMessage.innerText="Version mismatch. Possible incompatibility.";return new Promise(function(resolve){return setTimeout(resolve,2e3)})}})}).then(function(){return _fimod2.default.load()}).then(function(){loadingMessage.innerText="Loading Factory Idle...";var paths=["Main","lib/jquery","base/Logger","base/NumberFormat","lib/handlebars","text","lib/bin/Binary"];return _fimod2.default.require(paths).then(function(_ref3){var _ref4=_slicedToArray(_ref3,1);var Main=_ref4[0];window.GAME_LOADED=true;window.onerror=window.oldErrorHandler;window.BinaryTest.test();if(window.isBrowserSupported()){_fimod2.default.MainInstance=new Main;_fimod2.default.MainInstance.init(false,function(){})}})})},{"./fimod":1,"./lib/beforescriptexecute-polyfill.js":2,"./lib/utility":5,"./mods":12}],7:[function(require,module,exports){"use strict";var _fimod=require("../fimod");var _fimod2=_interopRequireDefault(_fimod);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{"default":obj}}_fimod2.default.define({name:"clearcloud",label:"Clear Cloud Saves",description:"Allows the deletion of cloud save slots"},["play/api/Web","play/api/api/PlayFabApi","play/SaveManager","ui/SettingsUi","ui/helper/ConfirmUi"],function(Web,PlayFabApi,SaveManager,SettingsUi,ConfirmUi){Web.prototype.clear=function(slot,done){this.playFabApi.clear(slot,done)};var name="PlayFab";PlayFabApi.prototype.clear=function(slot,done){var request={KeysToRemove:[slot,this._getMetaVarName(slot)]};window.PlayFab.ClientApi.UpdateUserData(request,function(response){if(response&&response.code==200){window.logger.info(name,"Cleared "+slot);done(true)}else{window.logger.error(name,"Clear failed!");done(false)}}.bind(this))};SaveManager.prototype._clearCloud=function(slot,done){if(this.useCloud){this.api.clear(slot,done)}else{window.logger.info(name,"Cloud save skipped!");done()}};_fimod2.default.wrap(SettingsUi,"_display",function(supr){var _this=this;for(var _len=arguments.length,args=Array(_len>1?_len-1:0),_key=1;_key<_len;_key++){args[_key-1]=arguments[_key]}supr.apply(undefined,args);var $panel=$("#settings");$panel.find(".loadSlot").each(function(i,node){var slot=$(node).attr("data-id");$(node).after('<input type="button" class="clearSlot" data-id="'+slot+'" value="Clear">')});$panel.find(".clearSlot").click(function(event){var slot=$(event.target).attr("data-id");var confirm=new ConfirmUi("Clear slot","Are you sure you want to clear this slot?");confirm.setOkTitle("Cancel").setCancelTitle("Yes, clear slot").setCancelCallback(function(){_this.saveManager._clearCloud(slot,function(){_this.hide()})}).display()})})})},{"../fimod":1}],8:[function(require,module,exports){"use strict";var _Fimod=require("../Fimod");var _Fimod2=_interopRequireDefault(_Fimod);var _utility=require("../lib/utility");function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{"default":obj}}var style="\n.controlsBox {\n  width: 17em;\n  float: right;\n}\n\n.controlsBox .clearPackagesButton {\n  width: 7em;\n}\n\n.controlsBox .clearFactoryButton {\n  width: 7em;\n  border: 1px solid darkred;\n}\n";var buttonTemplate='\n<a id="clearFactory" class="button clearFactoryButton" href="javascript:void(0);">Clear factory</a>\n';_Fimod2.default.define({name:"clearfactories",label:"Clear Factories",description:"Provides a button to remove all buildings from a factory floor"},["game/Factory","game/action/SellComponentAction","ui/factory/ControlsUi","ui/helper/ConfirmUi"],function(Factory,SellComponentAction,ControlsUi,ConfirmUi){(0,_utility.insertStyle)(style);_Fimod2.default.wrap(ControlsUi,"display",function(supr){var _this=this;for(var _len=arguments.length,args=Array(_len>1?_len-1:0),_key=1;_key<_len;_key++){args[_key-1]=arguments[_key]}supr.apply(undefined,args);var $container=this.container;var $tracksButton=$("#clearPackages",$container);var $factoryButton=$(buttonTemplate);$tracksButton.after($factoryButton);var sellComponents=function sellComponents(){_this.factory.getTiles().filter(function(tile){return tile.isMainComponentContainer()}).map(function(tile){var meta=tile.getComponent().meta;return new SellComponentAction(tile,meta.width,meta.height)}).map(function(action){if(action.canSell())action.sell();console.log(action.canSell())})};$factoryButton.click(function(_event){var confirm=new ConfirmUi("Clear slot","Are you sure you want to clear this factory?");confirm.setOkTitle("Cancel").setCancelTitle("Yes, clear factory").setCancelCallback(sellComponents).display()})})})},{"../Fimod":1,"../lib/utility":5}],9:[function(require,module,exports){"use strict";var _fimod=require("../fimod");var _fimod2=_interopRequireDefault(_fimod);var _utility=require("../lib/utility");function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{"default":obj}}var css="\n#gameArea .exportButton {\n  background-color: lavender;\n  border-color: darkslateblue;\n}\n\n#gameArea .exportBox {\n  width: 120px;\n  height: 60px;\n  margin: 18px auto 0 auto;\n  font-family: monospace;\n}\n";var components={wall:"#",floor:".",semi:",",none:" ",transportLine:"□╴╷┐╶─┌┬╵┘│┤└┴├┼",garbageCollector:"%",researchCenter:"@",researchCenter2:"@",researchCenter3:"@",metalsLab:"&",gasAndOilLab:"&",ironSeller:"$",steelSeller:"$",plasticSeller:"$",coalBuyer:"c",gasBuyer:"g",ironBuyer:"i",oilBuyer:"o",ironFoundry:"I",plasticMaker:"P",steelFoundry:"S"};_fimod2.default.define({name:"exportfactories",label:"Export Factories",description:"Allows exporting factory data to text notation"},["game/Factory","ui/FactoriesUi"],function(Factory,FactoriesUi){(0,_utility.insertStyle)(css,"style");Factory.prototype.exportToString=function(){var tiles=this.tiles.map(function(tile){var id=void 0;if(tile.component){id=tile.component.meta.id;if(id=="transportLine"){var i=tile.getInputOutputManager().getInputsByDirection();var o=tile.getInputOutputManager().getOutputsByDirection();var rep=[i.top||o.top,i.right||o.right,i.bottom||o.bottom,i.left||o.left].map(function(v){return v?"1":"0"}).join("");var s=parseInt(rep,2);return components[id][s]}}else{id=tile.terrain;if(id=="grass"||id=="road"){id=tile.buildableType=="-"?"semi":"none"}}if(id in components)return components[id];return"?"}).join("");var rows=[];for(var n=0;n<this.meta.tilesY;n++){rows.push(tiles.substr(n*this.meta.tilesX,this.meta.tilesX))}return rows.join("\n")};_fimod2.default.wrap(FactoriesUi,"display",function(supr,$container){var _this=this;supr($container);$(".factoryButton",$container).each(function(i,node){var level=$(node).attr("data-id");if(_this.game.getFactory(level).getIsBought()===false)return;var $export=$('<div class="button exportButton" data-id="'+level+'">EXPORT TEXT</div>');$(node).after($export);$export.click(function(){var string=_this.game.getFactory(level).exportToString();var $textarea=$('<textarea class="exportBox">'+string+"</textarea>");$export.after($textarea);$export.remove();$textarea.select()});$(node).append($export)})})})},{"../fimod":1,"../lib/utility":5}],10:[function(require,module,exports){"use strict";var _Fimod=require("../Fimod");var _Fimod2=_interopRequireDefault(_Fimod);var _common=require("../lib/common");function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{"default":obj}}var FACTORY_MOUSE_DOWN="FACTORY_MOUSE_DOWN";var FACTORY_MOUSE_MOVE="FACTORY_MOUSE_MOVE";var FACTORY_MOUSE_UP="FACTORY_MOUSE_UP";var FACTORY_MOUSE_OUT="FACTORY_MOUSE_OUT";_Fimod2.default.define({name:"fixmouse",label:"Fix Mouse",description:"Fixes mouse interaction for Firefox"},["ui/factory/mapLayers/MouseLayer"],function(MouseLayer){MouseLayer.prototype._setupNativeMouseEvents=function(){var _this=this;var last=void 0;this.element.get(0).addEventListener("mouseout",function(){_this.factory.getEventManager().invokeEvent(FACTORY_MOUSE_OUT,last);last=null},false);this.element.get(0).addEventListener("mousemove",function(event){var size={width:1,height:1};if(_this.selectedComponentMetaId){size=_this.game.getMeta().componentsById[_this.selectedComponentMetaId]}var rect=_this.element.get(0).getBoundingClientRect();var x=event.clientX-rect.left-_this.tileSize*size.width/2;var y=event.clientY-rect.top-_this.tileSize*size.height/2;var data={x:(0,_common.clamp)(Math.round(x/_this.tileSize),0,_this.tilesX-size.width),y:(0,_common.clamp)(Math.round(y/_this.tileSize),0,_this.tilesY-size.height),leftMouseDown:event.buttons&1,rightMouseDown:event.buttons&2,shiftKeyDown:event.shiftKey,altKeyDown:event.altKey};if(!last||last.x!=data.x||last.y!=data.y){_this.factory.getEventManager().invokeEvent(FACTORY_MOUSE_MOVE,data)}last=data},false);this.element.get(0).addEventListener("mousedown",function(event){var data={x:last.x,y:last.y,leftMouseDown:event.buttons&1,rightMouseDown:event.buttons&2,shiftKeyDown:event.shiftKey,altKeyDown:event.altKey};_this.factory.getEventManager().invokeEvent(FACTORY_MOUSE_DOWN,data)});this.element.get(0).addEventListener("mouseup",function(){_this.factory.getEventManager().invokeEvent(FACTORY_MOUSE_UP,last)})}})},{"../Fimod":1,"../lib/common":3}],11:[function(require,module,exports){"use strict";var _Fimod=require("../Fimod");var _Fimod2=_interopRequireDefault(_Fimod);var _utility=require("../lib/utility");function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{"default":obj}}var style="\nhtml {\n  overflow-y: auto;\n}\n\n#main {\n  display: table;\n  height: 100%;\n  width: 100%;\n}\n\n#adArea {\n  display: table-row;\n  height: 100px;\n}\n\n#gameArea {\n  display: table-row;\n  width: auto;\n  float: none;\n}\n\n#gameArea:before {\n  content: '';\n  display: block;\n  width: 100%;\n  height: 1px;\n  background: gray;\n  margin-top: -1px;\n}\n\n.factoryBox {\n  height: 100%;\n}\n\n#gameArea .overviewContainer,\n#gameArea .topContainer {\n  height: 110px;\n}\n\n#gameArea .bonusTicks {\n  padding-top: 0.5em;\n}\n\n.mapArea {\n  height: 100%;\n  width: 100%;\n}\n\n#gameArea .mapContainer {\n  height: 100%;\n}\n";_Fimod2.default.define({name:"fullscreenmode",label:"Fullscreen Mode",description:"Enables full-screen map"},["game/Game","ui/MainUi","ui/factory/MapUi"],function(Game,MainUi,MapUi){(0,_utility.insertStyle)(style);_Fimod2.default.wrap(MainUi,"display",function(supr){for(var _len=arguments.length,args=Array(_len>1?_len-1:0),_key=1;_key<_len;_key++){args[_key-1]=arguments[_key]}supr.apply(undefined,args);var $main=$("#main");var $adArea=$('<div id="adArea" class="ad_box"></div>');var $ads=$(".adsbygoogle").parent();$adArea.append($ads);$ads.last().remove();$("> br",$main).remove();$main.prepend($adArea).removeClass("main mainWithAdd")});_Fimod2.default.wrap(MapUi,"display",function(supr){var _this=this;for(var _len2=arguments.length,args=Array(_len2>1?_len2-1:0),_key2=1;_key2<_len2;_key2++){args[_key2-1]=arguments[_key2]}supr.apply(undefined,args);this._resize=function(){var reset={width:1,height:1};_this.container.css(reset);_this.overlay.css(reset);var size={width:_this.container.parent().width(),height:_this.container.parent().height()};_this.container.css(size);_this.overlay.css(size)};this._resize();window.addEventListener("resize",this._resize)});_Fimod2.default.wrap(MapUi,"destroy",function(supr){supr();window.removeEventListener("resize",this._resize)})})},{"../Fimod":1,"../lib/utility":5}],12:[function(require,module,exports){"use strict";require("./settings");require("./resetgame");require("./keyboardmovement");require("./fullscreenmode");require("./togglebackground");require("./clearfactories");require("./showefficiency");require("./exportfactories");require("./clearcloud");require("./fixmouse")},{"./clearcloud":7,"./clearfactories":8,"./exportfactories":9,"./fixmouse":10,"./fullscreenmode":11,"./keyboardmovement":13,"./resetgame":14,"./settings":15,"./showefficiency":16,"./togglebackground":17}],13:[function(require,module,exports){"use strict";var _fimod=require("../fimod");var _fimod2=_interopRequireDefault(_fimod);var _common=require("../lib/common");function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{"default":obj}}_fimod2.default.define({name:"keyboardmovement",label:"Keyboard Movement",description:"Enables use of WASD/arrow keys to navigate the map"},["ui/factory/mapLayers/MouseLayer"],function(MouseLayer){_fimod2.default.wrap(MouseLayer,"display",function(supr){for(var _len=arguments.length,args=Array(_len>1?_len-1:0),_key=1;_key<_len;_key++){args[_key-1]=arguments[_key]}supr.apply(undefined,args);this.setupKeyboardListener()});MouseLayer.prototype.setupKeyboardListener=function(){var _this=this;var moveTimer=void 0;var resizeTimer=void 0;var delay=5;var speed=5;var moving=[];var movements={UP:{top:1,left:0},LEFT:{top:0,left:1},DOWN:{top:-1,left:0},RIGHT:{top:0,left:-1}};var directions={87:"UP",65:"LEFT",83:"DOWN",68:"RIGHT",38:"UP",37:"LEFT",40:"DOWN",39:"RIGHT"};var applyMovement=function applyMovement(){var add=function add(a,b){return{top:a.top+b.top,left:a.left+b.left}};var movement={top:0,left:0};moving.map(function(direction){return movement=add(movement,movements[direction])});var element=_this.element.parent();var container=_this.container.parent();var offset=element.offset();var containerOffset=container.offset();element.offset({top:(0,_common.clamp)(offset.top+movement.top*speed,containerOffset.top-element.height()+container.height(),containerOffset.top),left:(0,_common.clamp)(offset.left+movement.left*speed,containerOffset.left-element.width()+container.width(),containerOffset.left)})};this._handleKeyboard=function(event){if(!(event.keyCode in directions))return;var direction=directions[event.keyCode];if(moving.indexOf(direction)!=-1)return;moving.push(direction);if(moveTimer===undefined)moveTimer=setInterval(applyMovement,delay);var stopMovement=function stopMovement(event){if(!(event.keyCode in directions))return;if(directions[event.keyCode]!=direction)return;var index=moving.indexOf(direction);if(index==-1)return;moving.splice(index,1);if(moving.length===0)moveTimer=clearInterval(moveTimer)};document.body.addEventListener("keyup",stopMovement)};this._handleResize=function(){if(resizeTimer!==undefined)clearTimeout(resizeTimer);resizeTimer=setTimeout(function(){return applyMovement()},100)};document.body.addEventListener("keydown",this._handleKeyboard);window.addEventListener("resize",this._handleResize)};_fimod2.default.wrap(MouseLayer,"destroy",function(supr){supr();document.body.removeEventListener("keydown",this._handleKeyboard);window.removeEventListener("resize",this._handleResize)})})},{"../fimod":1,"../lib/common":3}],14:[function(require,module,exports){"use strict";var _fimod=require("../fimod");var _fimod2=_interopRequireDefault(_fimod);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{"default":obj}}_fimod2.default.define({name:"resetgame",system:true},["ui/SettingsUi","ui/helper/ConfirmUi"],function(SettingsUi,ConfirmUi){_fimod2.default.wrap(SettingsUi,"_display",function(supr){var _this=this;for(var _len=arguments.length,args=Array(_len>1?_len-1:0),_key=1;_key<_len;_key++){args[_key-1]=arguments[_key]}supr.apply(undefined,args);var $resetButton=$("#resetGame");$resetButton.off("click");$resetButton.click(function(){new ConfirmUi("Reset game","Are you sure you want to reset the game?").setCancelTitle("Yes, RESET GAME").setOkTitle("Nooooo!!!").setCancelCallback(function(){_fimod2.default.MainInstance.destroy();_fimod2.default.MainInstance.init(true);_this.destroy()}).display()})})})},{"../fimod":1}],15:[function(require,module,exports){"use strict";var _fimod=require("../fimod");var _fimod2=_interopRequireDefault(_fimod);var _utility=require("../lib/utility");function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{"default":obj}}var style='\n.iframe .topArea {\n  font-size: 0.8em;\n}\n\n.iframe #fimod-settings {\n  font-size: 0.8em;\n}\n\n#fimodButton {\n  background: rgba(255, 128, 255, 0.2);\n}\n\n#fimodButton:hover {\n  background: rgba(255, 128, 255, 0.5);\n}\n\n.fullscreen-container {\n  position: absolute;\n  top: 0;\n  left: 0;\n  right: 0;\n  bottom: 0;\n}\n\n.fullscreen-background {\n  position: absolute;\n  top: 0;\n  left: 0;\n  right: 0;\n  bottom: 0;\n  background-color: black;\n  opacity: 0.7;\n}\n\n.fullscreen-window {\n  width: 500px;\n  top: 10px;\n  padding: 15px;\n  border: 1px solid rgb(225, 225, 232);\n  border-radius: 8px;\n  background-color: black;\n  font-size: 0.9em;\n  position: relative;\n  margin: 0 auto;\n}\n\n.fullscreen-window__close {\n  color: white;\n  font-weight: bold;\n  float: right;\n}\n\n.fullscreen-window__title {\n  font-size: 1.2em;\n  color: lightblue;\n}\n\n.toggle {\n  border-top: 2px solid rgba(255, 255, 255, 0.7);\n  padding: 1em 0;\n  clear: both;\n}\n\n.toggle__name {\n  font-size: 1.3em;\n  font-weight: bold;\n  padding: 0 0 0.4em;\n}\n\n.toggle__description {\n  opacity: 0.9;\n  font-size: 0.9em;\n}\n\n.toggle__control {\n  float: right;\n  padding: 0.5em 0 0;\n}\n\n.toggle__label {\n  position: relative;\n  display: block;\n  width: 100px;\n  height: 2em;\n  border-radius: 3px;\n}\n\n.toggle__label:before {\n  content: "";\n  display: block;\n  width: 40%;\n  position: absolute;\n  top: 0;\n  bottom: 0;\n  background: lightgray;\n  border-radius: 3px;\n  border: 3px solid red;\n}\n\n.toggle__input {\n  display: none;\n}\n\n.toggle__input + .toggle__label {\n  background: gray;\n}\n\n.toggle__input:checked + .toggle__label {\n  background: lightgray;\n}\n\n.toggle__input:checked + .toggle__label:before {\n  right: 0;\n  border-color: green;\n  background-color: greenyellow;\n}\n';var containerTemplate=function containerTemplate(version){return'\n<div class="fullscreen-container">\n  <div class="fullscreen-background"></div>\n  <div id="fimod-settings" class="fullscreen-window">\n    <a class="fullscreen-window__close" href="javascript:void(0);" style="float:right; display: block;">Close</a>\n    <b class="fullscreen-window__title">fimod <em>'+version+'</em></b>\n    <p>Toggle modules below. Refresh to load changes.</p>\n    <div class="options"></div>\n  </div>\n</div>\n'};var inputTemplate=function inputTemplate(module){return'\n<div class="toggle">\n  <div class="toggle__control">\n    <input type="checkbox" class="toggle__input" id="fimod-'+module.name+'">\n    <label for="fimod-'+module.name+'" class="toggle__label"></label>\n  </div>\n  <div class="toggle__info">\n    <div class="toggle__name">'+module.label+'</div>\n    <div class="toggle__description">'+module.description+"</div>\n  </div>\n</div>\n"};var buttonTemplate='\n<a id="fimodButton" href="javascript:void(0);">fimod</a>\n';_fimod2.default.define({name:"settings",system:true,weight:-1},["ui/factory/MenuUi"],function(MenuUi){(0,_utility.insertStyle)(style);function showFimodMenu(){var $container=$(containerTemplate(_fimod2.default.version));var $window=$(".fullscreen-window",$container);var $close=$(".fullscreen-window__close",$window);var $options=$(".options",$window);_fimod2.default.mods.filter(function(m){return!m.system}).map(function(module){var $element=$(inputTemplate(module));var $input=$("input",$element);$input.attr("checked",module.enabled);$input.change(function(event){module.toggle(event.target.checked)});$options.append($element)});function closeFimodMenu(){$container.remove()}$window.click(function(e){return e.stopPropagation()});$container.click(closeFimodMenu);$close.click(closeFimodMenu);$("body").append($container)}_fimod2.default.wrap(MenuUi,"display",function(supr){for(var _len=arguments.length,args=Array(_len>1?_len-1:0),_key=1;_key<_len;_key++){args[_key-1]=arguments[_key]}supr.apply(undefined,args);var $settings=$("#settingsButton");var $button=$(buttonTemplate);$button.click(showFimodMenu);$settings.after($button)})})},{"../fimod":1,"../lib/utility":5}],16:[function(require,module,exports){"use strict";var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();var _Fimod=require("../Fimod");var _Fimod2=_interopRequireDefault(_Fimod);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{"default":obj}}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}var FACTORY_TICK="FACTORY_TICK";var FACTORY_COMPONENTS_CHANGED="FACTORY_COMPONENTS_CHANGED";_Fimod2.default.define({name:"showefficiency",label:"Show Building Efficiency",description:"Puts an colored icon on each building to show its efficiency"},["ui/factory/MapUi"],function(MapUi){var colors=["#FF0000","#FF8000","#FFC000","#FFFF00","#C0FF00","#00FF00"];var namespace="LayerEfficiency";var EfficiencyLayer=function(){function EfficiencyLayer(imageMap,factory,meta){_classCallCheck(this,EfficiencyLayer);this.imageMap=imageMap;this.factory=factory;this.game=factory.getGame();this.tileSize=meta.tileSize;this.tilesX=factory.getMeta().tilesX;this.tilesY=factory.getMeta().tilesY;this.canvas=null;this.cache=[]}_createClass(EfficiencyLayer,[{key:"getCanvas",value:function getCanvas(){return this.canvas}},{key:"display",value:function display(container){var _this=this;this.container=container;this.canvas=document.createElement("canvas");this.canvas.style.position="absolute";this.canvas.width=this.tilesX*this.tileSize;this.canvas.height=this.tilesY*this.tileSize;this.canvas.style.pointerEvents="none";container.append(this.canvas);this.buildCache();this.redraw();this.factory.getEventManager().addListener(namespace,FACTORY_TICK,function(){if(_this.game.getTicker().getIsFocused()){_this.redraw()}});this.factory.getEventManager().addListener(namespace,FACTORY_COMPONENTS_CHANGED,function(){_this.buildCache();_this.clear();_this.redraw()})}},{key:"buildCache",value:function buildCache(){this.cache=this.factory.getTiles().filter(function(tile){return tile.isMainComponentContainer()}).map(function(tile){return{last:-1,component:tile.getComponent()}})}},{key:"clear",value:function clear(){var context=this.canvas.getContext("2d");context.clearRect(0,0,this.canvas.width,this.canvas.height)}},{key:"redraw",value:function redraw(){var _this2=this;var context=this.canvas.getContext("2d");this.cache.map(function(item){var last=item.last;var component=item.component;var data=component.getDescriptionData();var effectiveness=data.effectivenessStr;if(effectiveness===undefined)return;var efficiency=parseInt(effectiveness);if(isNaN(efficiency))return;if(last==efficiency)return;item.last=efficiency;_this2.drawEfficiency(context,component,efficiency)})}},{key:"drawEfficiency",value:function drawEfficiency(context,component,efficiency){var tile=component.getMainTile();var meta=component.getMeta();var size=this.tileSize;var iconSize=size/6;var x=tile.getX()*size+iconSize*1.5;var y=(tile.getY()+meta.height)*size-iconSize*1.5;context.fillStyle=colors[((colors.length-1)*(efficiency/100)).toFixed()];context.beginPath();context.arc(x,y,iconSize,0,2*Math.PI);context.fill()}}]);return EfficiencyLayer}();_Fimod2.default.wrap(MapUi,"display",function(supr){for(var _len=arguments.length,args=Array(_len>1?_len-1:0),_key=1;_key<_len;_key++){args[_key-1]=arguments[_key]}supr.apply(undefined,args);if(this.efficiencyLayer===undefined){this.efficiencyLayer=new EfficiencyLayer(this.imageMap,this.factory,{tileSize:this.tileSize
})}this.efficiencyLayer.display(this.element)})})},{"../Fimod":1}],17:[function(require,module,exports){"use strict";var _Fimod=require("../Fimod");var _Fimod2=_interopRequireDefault(_Fimod);var _utility=require("../lib/utility");function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{"default":obj}}var START_BACKGROUND_MODE="START_BACKGROUND_MODE";var STOP_BACKGROUND_MODE="STOP_BACKGROUND_MODE";var BACKGROUND_MODE_STARTED="BACKGROUND_MODE_STARTED";var BACKGROUND_MODE_STOPPED="BACKGROUND_MODE_STOPPED";var style="\n#togglebgButton {\n  float: right;\n}\n";var buttonTemplate='\n<a id="togglebgButton" href="javascript:void(0);">Background Mode</a>\n';_Fimod2.default.define({name:"togglebackground",label:"Toggle Background Mode",description:"Disables automatic background mode and adds a manual toggle"},["ui/MainUi","ui/factory/MenuUi","ui/RunningInBackgroundInfoUi","game/Ticker"],function(MainUi,MenuUi,RunningInBackgroundInfoUi,Ticker){(0,_utility.insertStyle)(style);_Fimod2.default.wrap(MainUi,"display",function(supr){for(var _len=arguments.length,args=Array(_len>1?_len-1:0),_key=1;_key<_len;_key++){args[_key-1]=arguments[_key]}supr.apply(undefined,args);this.runningInBackgroundInfoUi.play=this.play});_Fimod2.default.wrap(MenuUi,"display",function(supr){var _this=this;for(var _len2=arguments.length,args=Array(_len2>1?_len2-1:0),_key2=1;_key2<_len2;_key2++){args[_key2-1]=arguments[_key2]}supr.apply(undefined,args);var $box=$(".menuBox",this.container);var $button=$(buttonTemplate);$button.click(function(){_this.globalUiEm.invokeEvent(START_BACKGROUND_MODE)});$box.append($button)});var runningNamespace="RunningInBackgroundInfoUi";RunningInBackgroundInfoUi.prototype.delayedDisplay=function(){};_Fimod2.default.wrap(RunningInBackgroundInfoUi,"init",function(){var _this2=this;this.globalUiEm.addListener(runningNamespace,START_BACKGROUND_MODE,function(){_this2.play.game.getEventManager().invokeEvent(BACKGROUND_MODE_STARTED);_this2.display()});this.globalUiEm.addListener(runningNamespace,STOP_BACKGROUND_MODE,function(){_this2.play.game.getEventManager().invokeEvent(BACKGROUND_MODE_STOPPED);_this2.hide()})});_Fimod2.default.wrap(RunningInBackgroundInfoUi,"display",function(supr){var _this3=this;for(var _len3=arguments.length,args=Array(_len3>1?_len3-1:0),_key3=1;_key3<_len3;_key3++){args[_key3-1]=arguments[_key3]}supr.apply(undefined,args);var blur=function blur(){_this3.globalUiEm.invokeEvent(STOP_BACKGROUND_MODE)};this.backgroundElement.click(blur);this.containerElement.click(blur)});var tickerNamespace="Ticker";_Fimod2.default.wrap(Ticker,"init",function(supr){var _this4=this;supr();this.game.getEventManager().addListener(tickerNamespace,BACKGROUND_MODE_STARTED,function(){_this4.startBackgroundMode()});this.game.getEventManager().addListener(tickerNamespace,BACKGROUND_MODE_STOPPED,function(){_this4.stopBackgroundMode()})});Ticker.prototype.startBackgroundModeTimer=function(){};Ticker.prototype.startBackgroundMode=function(){this.focused=false;this.updateInterval()};Ticker.prototype.disableBackgroundMode=function(){};Ticker.prototype.stopBackgroundMode=function(){this.focused=true;this.updateInterval()}})},{"../Fimod":1,"../lib/utility":5}]},{},[6]);
